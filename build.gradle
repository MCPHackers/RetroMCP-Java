plugins {
    id 'application'
    id 'com.github.johnrengelman.shadow' version '7.1.2'
}

sourceCompatibility = JavaVersion.VERSION_1_8
targetCompatibility = JavaVersion.VERSION_1_8

mainClassName = 'org.mcphackers.mcp.main.MainCLI'

repositories {
    mavenCentral()
    maven { url 'https://jitpack.io' }
    maven { url 'https://maven.fabricmc.net/' }
    flatDir {
        dirs "libs"
    }
}

dependencies {
    def ASMVersion = '9.3'

    // Required libraries
    implementation 'org.ow2.asm:asm:' + ASMVersion
    implementation 'org.ow2.asm:asm-analysis:' + ASMVersion
    implementation 'org.ow2.asm:asm-commons:' + ASMVersion
    implementation 'org.ow2.asm:asm-tree:' + ASMVersion
    implementation 'org.ow2.asm:asm-util:' + ASMVersion

    implementation 'com.github.MCPHackers:RetroFernflower:3992b4b81fe2b106f2e53dca2d7425fce72dd9f5'
    implementation 'org.fusesource.jansi:jansi:2.4.0'
    implementation 'net.fabricmc:tiny-remapper:0.8.2'
    // TODO: Don't gut MCInjector bundled ASM
    implementation name: 'mcinjector'
    implementation 'org.json:json:20220320'
    implementation 'com.github.MCPHackers:DiffPatch:e2473fdba3'
    implementation 'net.fabricmc:mapping-io:0.3.0'
}

application {
    // Redirect all execution into the testing folder
    mainClass = mainClassName
    executableDir = 'test'
}

shadowJar {
    minimize()
}

runShadow {

}

task decompile(type: JavaExec) {
    group 'RetroMCP-Java'

    classpath = sourceSets.main.runtimeClasspath
    mainClass.set(mainClassName)
    workingDir 'test'
    args 'decompile', '-debug'
}

task startClient(type: JavaExec) {
    group 'RetroMCP-Java'

    classpath = sourceSets.main.runtimeClasspath
    mainClass.set(mainClassName)
    workingDir 'test'
    args 'startclient', '-debug'
}

task startServer(type: JavaExec) {
    group 'RetroMCP-Java'

    classpath = sourceSets.main.runtimeClasspath
    mainClass.set(mainClassName)
    workingDir 'test'
    args 'startserver', '-debug'
}

task recompile(type: JavaExec) {
    group 'RetroMCP-Java'

    classpath = sourceSets.main.runtimeClasspath
    mainClass.set(mainClassName)
    workingDir 'test'
    args 'recompile', '-debug'
}

task reobfuscate(type: JavaExec) {
    group 'RetroMCP-Java'

    classpath = sourceSets.main.runtimeClasspath
    mainClass.set(mainClassName)
    workingDir 'test'
    args 'reobfuscate', '-debug'
}

task update_md5(type: JavaExec) {
    group 'RetroMCP-Java'

    classpath = sourceSets.main.runtimeClasspath
    mainClass.set(mainClassName)
    workingDir 'test'
    args 'updatemd5', '-debug'
}

task setup(type: JavaExec) {
    group = 'RetroMCP-Java'
    standardInput = System.in

    classpath = sourceSets.main.runtimeClasspath
    mainClass.set(mainClassName)
    workingDir 'test'
    args 'setup', '-debug'
}

task cleanup(type: JavaExec) {
    group = 'RetroMCP-Java'
    standardInput = System.in

    classpath = sourceSets.main.runtimeClasspath
    mainClass.set(mainClassName)
    workingDir 'test'
    args 'cleanup', '-debug'
}

task createpatch(type: JavaExec) {
    group = 'RetroMCP-Java'
    standardInput = System.in

    classpath = sourceSets.main.runtimeClasspath
    mainClass.set(mainClassName)
    workingDir 'test'
    args 'createpatch', '-debug'
}
